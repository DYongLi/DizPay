{% extends 'layout.html' %}
{% set isShowBack = True %}
{% set isShowExit = True %}

{% block head %}
    <style>
        .select-container .select-header {
            height: 55px;
            line-height: 55px;
            border-bottom: 1px solid #EDEDED;
        }

        .select-container .select-header .item {
            float: left;
            width: 50%;
            text-align: center;
            height: 100%;
            cursor: pointer;
        }

        .select-container .select-header div {
            width: 60px;
            margin: 0 auto;
        }

        .select-container .select-header .item.active div {
            color: #35BADB;
            border-bottom: 3px solid #35BADB;
            height: 100%;
        }

        .select-content .currency-item {
            height: 68px;
            line-height: 68px;
            border: 1px solid #EDEDED;
            border-radius: 4px;
            padding: 0 16px;
            position: relative;
            font-size: 22px;
            margin-top: 22px;
            cursor: pointer;
        }

        .currency-item .currency {
            margin-left: 16px;
        }

        .currency-item .amount {
            position: absolute;
            right: 16px;
        }

        .currency-detail div:not(:first-child) {
            text-align: center;
            margin-top: 16px;
        }

        .currency-detail .currency-item {
            border-top: none;
            border-left: none;
            border-right: none;
            margin: 0;
        }

        .currency-detail .qr-code img {
            width: 126px;
        }

        .currency-detail .copy {
            color: #32B8DA;
            cursor: pointer;
        }

        .product-item {
            padding: 36px 0;
            border-bottom: 1px solid #ededed;
        }

        .product-item .img-content {
            background: #FFFFFF;
            box-shadow: 0 2px 6px 0 rgba(0, 0, 0, 0.12);
            border-radius: 6px;
            float: left;
            width: 72px;
            height: 72px;
            line-height: 72px;
            text-align: center;
        }

        .product-item .img-content img {
            width: 40px;
        }

        .product-item .detail {
            float: left;
            margin-left: 16px;
            width: calc(100% - 88px);
        }

        .product-item .name-container {
            position: relative;
        }

        .product-item .name-container .name {
            font-size: 18px;
        }

        .product-item .btn-buy {
            position: absolute;
            right: 0;
            display: inline-block;
            background: #32B8DA;
            border-radius: 4px;
            width: 60px;
            height: 28px;
            line-height: 28px;
            color: #fff;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
        }

        .product-detail-container {
            border-bottom: 1px solid #ededed;
        }

        .product-detail-container .item {
            padding: 10px 0;
        }

        .product-detail-container .item div {
            float: left;
            width: 50%;
        }

        .product-detail .btn-container .btn-pay {
            display: inline-block;
            width: 100%;
            height: 56px;
            line-height: 56px;
            background: #32B8DA;
            border-radius: 4px;
            color: #fff;
            font-size: 18px;
            text-align: center;
            margin-top: 30px;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
{% endblock %}

{% block content %}
    <div class="select-container">
        <div class="select-header clearfix">
            <div class="item active">
                <div>Assets</div>
            </div>
            <div class="item">
                <div>Product</div>
            </div>
        </div>
        <div class="select-content">
            <div class="pdd-30" id="assets">
                <div class="currency-list" id="currency_list">
                </div>
                <div class="currency-detail none" id="currency_detail">
                </div>
            </div>
            <div id="product" class="pdd-30 none">
                <div class="product-list">
                    <div class="product-item clearfix">
                        <div class="img-content">
                            <img src="/static/assets/img/icon/product.png"/>
                        </div>
                        <div class="detail">
                            <div class="name-container">
                                <span class="name">Test Product 1</span>
                                <a class="btn-buy">Buy</a>
                            </div>
                            <div class="price">0.1USD</div>
                            <div class="note">Note：Payment does not charge fees</div>
                        </div>
                    </div>
                    <div class="product-item clearfix">
                        <div class="img-content">
                            <img src="/static/assets/img/icon/product.png"/>
                        </div>
                        <div class="detail">
                            <div class="name-container">
                                <span class="name">Test Product 2</span>
                                <a class="btn-buy">Buy</a>
                            </div>
                            <div class="price">0.1USD</div>
                            <div class="note">Note：Payment collection fees</div>
                        </div>
                    </div>
                </div>
                <div class="product-detail none">
                    <div class="product-item clearfix">
                        <div class="img-content">
                            <img src="/static/assets/img/icon/product.png"/>
                        </div>
                        <div class="detail">
                            <div class="name-container">
                                <span class="name">Test Product 2</span>
                            </div>
                            <div class="price">0.1USD</div>
                            <div class="note">Note：Payment collection fees</div>
                        </div>
                    </div>
                    <div class="product-detail-container" id="product_detail">
                        <div class="item clearfix">
                            <div>Payment Method</div>
                            <div>
                                <label class="radio-inline">
                                    <input type="radio" name="currency" checked value="BTC">
                                    BTC
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="currency" value="ETH">
                                    ETH
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="currency" value="LTC">
                                    LTC
                                </label>
                            </div>
                        </div>
                        <div class="item clearfix">
                            <div class="amount-container">Amount:
                                <span class="btc"></span>
                                <span class="eth none"></span>
                                <span class="ltc none"></span>
                            </div>
                            <div class="fees">
                                <span class="btc-fee">0.00001BTC</span>
                                <span class="eth-fee none">0.0001ETH</span>
                                <span class="ltc-fee none">0.001LTC</span>
                            </div>
                        </div>
                    </div>
                    <div class="btn-container">
                        <a class="btn-pay">Confirm Payment</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script id="currency_list_template" type="text/x-jquery-tmpl">
        {% raw %}
        {{each(i, wallet) wallets}}
            <div class="currency-item" data-currencydetail="${JSON.stringify(wallet)}">
                <img src="${wallet.icon}"/>
                <span class="currency">${wallet.currency_id}</span>
                <span class="amount">${wallet.balance}</span>
            </div>
        {{/each}}
        {% endraw %}




    </script>

    <script id="currency_detail_template" type="text/x-jquery-tmpl">
        {% raw %}
        <div class="currency-item">
            <img src="${wallet.icon}"/>
            <span class="currency">${wallet.currency_id}</span>
            <span class="amount">${wallet.balance}</span>
        </div>
        <div class="qr-code">
            <img src="${wallet.address_qr_code}">
        </div>
        <div id="address">${wallet.address}</div>
        <div class="copy" data-clipboard-target="#address">Copy Address</div>
        {% endraw %}




    </script>
{% endblock %}

{% block script %}
    <script>
        $(function () {
            var $assets = $("#assets");
            var $product = $("#product");
            var index = 0;
            var productIndex = 0;
            var currencyIndex = 0;
            var faitCurrency = 0.1;
            var walletList = [];
            var currencyAmount = [];
            var $currencyContainer = $("#product_detail");
            var currencyIconList = ['/static/assets/img/icon/BTC.png', '/static/assets/img/icon/ETH.png', '/static/assets/img/icon/LTC.png'];

            var clipboard = new ClipboardJS(".copy");

            clipboard.on('success', function (e) {
                layer.msg("Copy Success");
            });

            $(".deposit-demo").find(".left").hide();

            $(".select-header").find(".item").click(function () {
                index = $(this).index();
                $(this).addClass("active").siblings(".item").removeClass("active");
                initSelect(index)
            });

            $assets.on("click", ".currency-list .currency-item", function () {
                $("#currency_detail").empty();
                $(".deposit-demo").find(".left").show();
                $assets.find(".currency-list").hide();
                $assets.find(".currency-detail").show();
                var wallet = $(this).data("currencydetail");
                switch (wallet.currency_id) {
                    case 'BTC':
                        wallet.icon = currencyIconList[0];
                        break;
                    case 'ETH':
                        wallet.icon = currencyIconList[1];
                        break;
                    case 'LTC':
                        wallet.icon = currencyIconList[2];
                        break;
                }
                $("#currency_detail_template").tmpl({wallet: wallet}).appendTo($("#currency_detail"))
            });

            $product.on("click", ".btn-buy", function () {
                productIndex = $(this).parents(".product-item").index();
                $(".deposit-demo").find(".left").show();
                $product.find(".product-list").hide();
                $product.find(".product-detail").show();
                $product.find(".product-detail .fees").show();
                if (productIndex == 0) {
                    $product.find(".product-detail .fees").hide();
                    $product.find(".product-detail .name-container .name").text('Test Product 1');
                } else {
                    $product.find(".product-detail .name-container .name").text('Test Product 2');
                }
                $product.find(".product-detail input").each(function () {
                    if($(this).parents(".radio-inline").index() != 0) {
                        $(this).prop("checked", false);
                    }
                });
                getCurrencyConvert();
            });

            $(".deposit-demo").find(".left").click(function () {
                initSelect(index);
                $(".deposit-demo").find(".left").hide();
            });

            $("#product_detail").find(".radio-inline").click(function () {
                currencyIndex = $(this).index();
                switch (currencyIndex) {
                    case 0:
                        $currencyContainer.find(".btc").show().siblings().hide();
                        if (productIndex == 1) {
                            $currencyContainer.find(".btc-fee").show().siblings().hide();
                        }
                        break;
                    case 1:
                        $currencyContainer.find(".eth").show().siblings().hide();
                        if (productIndex == 1) {
                            $currencyContainer.find(".eth-fee").show().siblings().hide();

                        }
                        break;
                    case 2:
                        $currencyContainer.find(".ltc").show().siblings().hide();
                        if (productIndex == 1) {
                            $currencyContainer.find(".ltc-fee").show().siblings().hide();

                        }
                        break;
                }
            });

            $("#product").find(".btn-pay").click(function () {
                var params = {
                    currency: 'BTC',
                    amount: 0,
                    fee: 0
                };
                switch (currencyIndex) {
                    case 0:
                        params.amount = $currencyContainer.find(".btc").text();
                        if (productIndex == 1) {
                            params.fee = 0.00001
                        }
                        break;
                    case 1:
                        params.amount = $currencyContainer.find(".eth").text();
                        if (productIndex == 1) {
                            params.fee = 0.0001
                        }
                        break;
                    case 2:
                        params.amount = $currencyContainer.find(".ltc").text();
                        if (productIndex == 1) {
                            params.fee = 0.001
                        }
                        break;
                }
                params.amount = parseFloat(params.amount);
                load = layer.load(2, {
                    shade: [0.6, '#000'],
                    scrollbar: false
                });
                $.ajax({
                    type: 'POST',
                    data: JSON.stringify(params),
                    url: '/api/transfer_order',
                    json: true,
                    contentType: 'application/json',
                    success: function (data) {
                        layer.msg('payment successful');
                    },
                    error: function (err) {
                        var code = err.responseJSON.code;
                        if (code == 1008) {
                            layer.msg('Insufficient balance');
                        }
                    }
                }).always(function () {
                    layer.close(load);
                });
            });

            function initSelect(index) {
                if (index == 0) {
                    $assets.show();
                    $assets.find(".currency-list").show();
                    $assets.find(".currency-detail").hide();
                    $product.hide();
                } else {
                    $product.show();
                    $product.find(".product-list").show();
                    $product.find(".product-detail").hide();
                    $assets.hide();
                }
            }

            getWallet();

            function getWallet() {
                $.getJSON('/api/wallet', function (data) {
                    var wallets = data.objects;
                    if (wallets.length) {
                        $.each(wallets, function (index, wallet) {
                            wallet.icon = currencyIconList[index];
                        });
                        $("#currency_list_template").tmpl({wallets: wallets}).appendTo($("#currency_list"))
                        walletList = wallets;
                    }
                })
            }

            function getCurrencyConvert() {
                var load = layer.load(2, {
                    shade: [0.6, '#000'],
                    scrollbar: false
                });
                $.getJSON('/api/currency_convert', function (data) {
                    layer.close(load);
                    if (data.length) {
                        $.each(data, function (index, item) {
                            switch (item.symbol) {
                                case 'BTC':
                                    var currencyVal = (faitCurrency / item.price_usd).toFixed(8);
                                    $currencyContainer.find(".btc").text(currencyVal + item.symbol);
                                    currencyAmount.push({BTC: currencyVal});
                                    break;
                                case 'ETH':
                                    var currencyVal = (faitCurrency / item.price_usd).toFixed(8);
                                    $currencyContainer.find(".eth").text(currencyVal + item.symbol);
                                    currencyAmount.push({ETH: currencyVal});
                                    break;
                                case 'LTC':
                                    var currencyVal = (faitCurrency / item.price_usd).toFixed(8);
                                    $currencyContainer.find(".ltc").text(currencyVal + item.symbol);
                                    console.log(currencyAmount);
                                    currencyAmount.push({LTC: currencyVal});
                                    break;
                            }
                        })
                    }
                })
            }

        })
    </script>
{% endblock %}